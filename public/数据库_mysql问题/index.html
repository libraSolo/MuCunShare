<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>数据库_MySQL - 我的新Hugo网站</title><meta name="Description" content="这是我的酷站"><meta property="og:url" content="http://localhost:1313/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98/">
  <meta property="og:site_name" content="我的新Hugo网站">
  <meta property="og:title" content="数据库_MySQL">
  <meta property="og:description" content="数据库_MySQL 索引 索引的分类 按照索引结构 B 树索引 使用 B / B&#43; 树结构，高效的查找、插入和删除。 适用于范围查询。 哈希索引 使用哈希表实现，查找速度很快，不支持范围查询。 适用于查找特定的值。 位图索引 使用位图表示数据，适用于不同值较少的列 适用于大规模查询。 按照索引的使用方式 主键索引 基于表的主键创建的索引，自动创建，确保主键唯一性。 唯一索引 确保索引列中的值唯一，不能包含重复值。 可以用于非主键列。 普通索引 没有唯一性，可以包含重复值。 增加查询速度，不保证唯一性。 复合索引 由多个列组成的索引，支持多列查询。 提高查询的复杂性。 前缀索引 包含某个列的前一部分。 适用于储存字符/字节的列。 覆盖索引 某个索引包含某个查询的所有列。 按照储存方式 聚集索引 数据存储顺序与索引顺序相同，表中的数据行按照索引的顺序排列。 每个表只能有一个聚集索引，因为数据行只能按一种方式存储。 非聚集索引 索引与数据存储分开，索引包含指向数据行的指针。 一个表可以有多个非聚集索引。 特殊类型 全文索引 专门用于文本搜索，支持对文本数据进行复杂查询。 常用于搜索引擎和内容管理系统。 空间索引 用于地理信息系统（GIS）中的空间数据查询。 索引的代价 索引本身需要存储起来，消耗磁盘空间。 运行时，索引会加载到内存中，消耗内存空间。 增删改的时候，同步维护索引，引入额外的消耗。 B&#43; 树的优势 B&#43; 树的高度更低，所以查询耗时更少，性能更好。 B&#43; 树的叶子节点被串联起来了，更适合范围查询。 B&#43; 树的非叶子节点没有存放数据，所以可以放在内存中，查询性能更好。 QA:数据库索引为什么用 B&#43; 树 与 B&#43; 树相比，平衡二叉树、红黑树在同等数据量下，高度更高，性能更差，而且它们会频繁执行再平衡过程，来保证树形结构平衡。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-01T16:21:57+08:00">
    <meta property="article:modified_time" content="2024-09-01T16:21:57+08:00">
    <meta property="og:image" content="http://localhost:1313/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/logo.png">
  <meta name="twitter:title" content="数据库_MySQL">
  <meta name="twitter:description" content="数据库_MySQL 索引 索引的分类 按照索引结构 B 树索引 使用 B / B&#43; 树结构，高效的查找、插入和删除。 适用于范围查询。 哈希索引 使用哈希表实现，查找速度很快，不支持范围查询。 适用于查找特定的值。 位图索引 使用位图表示数据，适用于不同值较少的列 适用于大规模查询。 按照索引的使用方式 主键索引 基于表的主键创建的索引，自动创建，确保主键唯一性。 唯一索引 确保索引列中的值唯一，不能包含重复值。 可以用于非主键列。 普通索引 没有唯一性，可以包含重复值。 增加查询速度，不保证唯一性。 复合索引 由多个列组成的索引，支持多列查询。 提高查询的复杂性。 前缀索引 包含某个列的前一部分。 适用于储存字符/字节的列。 覆盖索引 某个索引包含某个查询的所有列。 按照储存方式 聚集索引 数据存储顺序与索引顺序相同，表中的数据行按照索引的顺序排列。 每个表只能有一个聚集索引，因为数据行只能按一种方式存储。 非聚集索引 索引与数据存储分开，索引包含指向数据行的指针。 一个表可以有多个非聚集索引。 特殊类型 全文索引 专门用于文本搜索，支持对文本数据进行复杂查询。 常用于搜索引擎和内容管理系统。 空间索引 用于地理信息系统（GIS）中的空间数据查询。 索引的代价 索引本身需要存储起来，消耗磁盘空间。 运行时，索引会加载到内存中，消耗内存空间。 增删改的时候，同步维护索引，引入额外的消耗。 B&#43; 树的优势 B&#43; 树的高度更低，所以查询耗时更少，性能更好。 B&#43; 树的叶子节点被串联起来了，更适合范围查询。 B&#43; 树的非叶子节点没有存放数据，所以可以放在内存中，查询性能更好。 QA:数据库索引为什么用 B&#43; 树 与 B&#43; 树相比，平衡二叉树、红黑树在同等数据量下，高度更高，性能更差，而且它们会频繁执行再平衡过程，来保证树形结构平衡。">
<meta name="application-name" content="我的酷站">
<meta name="apple-mobile-web-app-title" content="我的酷站"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98/" /><link rel="prev" href="http://localhost:1313/go%E5%B9%B6%E5%8F%91%E5%9F%BA%E6%9C%AC%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%ADwaitgroup/" /><link rel="next" href="http://localhost:1313/%E6%95%B0%E6%8D%AE%E5%BA%93_redis/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "数据库_MySQL",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98\/"
        },"genre": "posts","wordcount":  442 ,
        "url": "http:\/\/localhost:1313\/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98\/","datePublished": "2024-09-01T16:21:57+08:00","dateModified": "2024-09-01T16:21:57+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "木村凉太"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="我的新Hugo网站"></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="我的新Hugo网站"></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">数据库_MySQL</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>木村凉太</a></span>&nbsp;<span class="post-category">included in <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>数据库</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2024-09-01">2024-09-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;442 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;3 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#索引的分类">索引的分类</a></li>
    <li><a href="#索引的代价">索引的代价</a></li>
    <li><a href="#b-树的优势">B+ 树的优势</a></li>
    <li><a href="#qa数据库索引为什么用-b-树">QA:数据库索引为什么用 B+ 树</a></li>
    <li><a href="#qa为什么数据库不使用索引">QA:为什么数据库不使用索引</a></li>
    <li><a href="#qa索引与-null-的特殊之处">QA:索引与 NULL 的特殊之处</a></li>
  </ul>

  <ul>
    <li><a href="#explain">explain</a></li>
    <li><a href="#优化">优化</a></li>
  </ul>

  <ul>
    <li><a href="#锁的类型">锁的类型</a>
      <ul>
        <li><a href="#乐观锁和悲观锁">乐观锁和悲观锁</a></li>
        <li><a href="#行锁与表锁">行锁与表锁</a></li>
        <li><a href="#共享锁和排他锁">共享锁和排他锁</a></li>
        <li><a href="#意向锁">意向锁</a></li>
        <li><a href="#记录锁间隙锁和临键锁">记录锁、间隙锁和临键锁</a></li>
      </ul>
    </li>
    <li><a href="#qa介绍一下-mysql-锁">QA:介绍一下 MySQL 锁</a></li>
    <li><a href="#qa临键锁引发的死锁">QA:临键锁引发的死锁</a></li>
  </ul>

  <ul>
    <li><a href="#隔离级别从低到高">隔离级别(从低到高)</a></li>
    <li><a href="#异常">异常</a></li>
    <li><a href="#快照读和当前读">快照读和当前读</a></li>
    <li><a href="#read-view">Read View</a></li>
    <li><a href="#qa什么是-mccc-">QA:什么是 MCCC ?</a></li>
  </ul>

  <ul>
    <li><a href="#undo-log回滚日志">undo log(回滚日志)</a></li>
    <li><a href="#redo-log操作日志">redo log(操作日志)</a></li>
    <li><a href="#acid">ACID</a></li>
  </ul>

  <ul>
    <li><a href="#uuid">UUID</a>
      <ul>
        <li><a href="#弊端">弊端</a></li>
        <li><a href="#页分裂">页分裂</a></li>
        <li><a href="#顺序读"><strong>顺序读</strong></a></li>
      </ul>
    </li>
    <li><a href="#数据库自增设置步长">数据库自增(设置步长)</a></li>
    <li><a href="#雪花算法">雪花算法</a>
      <ul>
        <li><a href="#序列号耗尽">序列号耗尽</a></li>
        <li><a href="#数据堆积">数据堆积</a></li>
      </ul>
    </li>
    <li><a href="#主键内嵌分库分表键"><strong>主键内嵌分库分表键</strong></a></li>
  </ul>

  <ul>
    <li><a href="#分库分表">分库分表</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="数据库_mysql">数据库_MySQL</h1>
<h1 id="索引">索引</h1>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/2024/09/2632954084.jpg"
        data-srcset="/images/2024/09/2632954084.jpg, /images/2024/09/2632954084.jpg 1.5x, /images/2024/09/2632954084.jpg 2x"
        data-sizes="auto"
        alt="/images/2024/09/2632954084.jpg"
        title="请输入图片描述" width="1280" height="1183" /></p>
<h2 id="索引的分类">索引的分类</h2>
<ul>
<li>按照索引结构
<ol>
<li>B 树索引
<ul>
<li>使用 B / B+ 树结构，高效的查找、插入和删除。</li>
<li>适用于范围查询。</li>
</ul>
</li>
<li>哈希索引
<ul>
<li>使用哈希表实现，查找速度很快，不支持范围查询。</li>
<li>适用于查找特定的值。</li>
</ul>
</li>
<li>位图索引
<ul>
<li>使用位图表示数据，适用于不同值较少的列</li>
<li>适用于大规模查询。</li>
</ul>
</li>
</ol>
</li>
<li>按照索引的使用方式
<ol>
<li>主键索引
<ul>
<li>基于表的主键创建的索引，自动创建，确保主键唯一性。</li>
</ul>
</li>
<li>唯一索引
<ul>
<li>确保索引列中的值唯一，不能包含重复值。</li>
<li>可以用于非主键列。</li>
</ul>
</li>
<li>普通索引
<ul>
<li>没有唯一性，可以包含重复值。</li>
<li>增加查询速度，不保证唯一性。</li>
</ul>
</li>
<li>复合索引
<ul>
<li>由多个列组成的索引，支持多列查询。</li>
<li>提高查询的复杂性。</li>
</ul>
</li>
<li>前缀索引
<ul>
<li>包含某个列的前一部分。</li>
<li>适用于储存字符/字节的列。</li>
</ul>
</li>
<li>覆盖索引
某个索引包含某个查询的所有列。</li>
</ol>
</li>
<li>按照储存方式
<ol>
<li>聚集索引
<ul>
<li>数据存储顺序与索引顺序相同，表中的数据行按照索引的顺序排列。</li>
<li>每个表只能有一个聚集索引，因为数据行只能按一种方式存储。</li>
</ul>
</li>
<li>非聚集索引
<ul>
<li>索引与数据存储分开，索引包含指向数据行的指针。</li>
<li>一个表可以有多个非聚集索引。</li>
</ul>
</li>
</ol>
</li>
<li>特殊类型
<ol>
<li>全文索引
<ul>
<li>专门用于文本搜索，支持对文本数据进行复杂查询。</li>
<li>常用于搜索引擎和内容管理系统。</li>
</ul>
</li>
<li>空间索引
<ul>
<li>用于地理信息系统（GIS）中的空间数据查询。</li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="索引的代价">索引的代价</h2>
<ol>
<li>索引本身需要存储起来，消耗磁盘空间。</li>
<li>运行时，索引会加载到内存中，消耗内存空间。</li>
<li>增删改的时候，同步维护索引，引入额外的消耗。</li>
</ol>
<h2 id="b-树的优势">B+ 树的优势</h2>
<ol>
<li>B+ 树的高度更低，所以查询耗时更少，性能更好。</li>
<li>B+ 树的叶子节点被串联起来了，更适合范围查询。</li>
<li>B+ 树的非叶子节点没有存放数据，所以可以放在<strong>内存</strong>中，查询性能更好。</li>
</ol>
<h2 id="qa数据库索引为什么用-b-树">QA:数据库索引为什么用 B+ 树</h2>
<p>与 B+ 树相比，<strong>平衡二叉树</strong>、<strong>红黑树</strong>在同等数据量下，高度更高，性能更差，而且它们会频繁执行再平衡过程，来保证树形结构平衡。</p>
<p>与 B+ 树相比，<strong>跳表</strong>在极端情况下会退化为链表，<strong>平衡性差</strong> ，而数据库查询需要一个可预期的查询时间，并且跳表需要更多的内存。</p>
<p>与 B+ 树相比，B 树的数据存储在全部节点中，<strong>对范围查询不友好</strong> 。非叶子节点存储了数据，<strong>导致内存中难以放下全部非叶子节点</strong> 。如果内存放不下非叶子节点，那么就意味着查询非叶子节点的时候都需要磁盘 IO。</p>
<h2 id="qa为什么数据库不使用索引">QA:为什么数据库不使用索引</h2>
<p><strong>可能</strong>的原因：</p>
<ul>
<li>使用了 !=、Like 之类的查询</li>
<li>字段区分不大</li>
<li>使用了特殊的表达式，包括数学运算和函数调用。</li>
<li>数据量太小</li>
</ul>
<blockquote>
<p>有一种说法是含有 NULL 的列上的索引会失效，不过这个说法并不准确，实际上 MySQL 还是会尽可能用索引的。</p></blockquote>
<h2 id="qa索引与-null-的特殊之处">QA:索引与 NULL 的特殊之处</h2>
<p>NULL 通常表示 不知道、不存在、不合法等语义。</p>
<p>MySQL 会尽可能使用索引，即使有零值，并且 is null 和 is not null 都可以使用索引。</p>
<p>其次 MySQL 的唯一索引允许有多行的值都是 NULL。也就是说你可以有很多行唯一索引的列的值都是 NULL。但是不管怎么说，使用 NULL 都是一个比较差的实践。</p>
<h1 id="sql-优化">SQL 优化</h1>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/2024/09/3281862012.png"
        data-srcset="/images/2024/09/3281862012.png, /images/2024/09/3281862012.png 1.5x, /images/2024/09/3281862012.png 2x"
        data-sizes="auto"
        alt="/images/2024/09/3281862012.png"
        title="请输入图片描述" width="1280" height="1120" /></p>
<h2 id="explain">explain</h2>
<p><code>explain + sql语句</code></p>
<p><strong>type</strong> ：指的是查询到所需行的方式，从好到坏依次是 system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL。
<strong>possible_keys</strong>：候选索引。
<strong>key</strong>：实际用的索引。
<strong>rows</strong>：扫描的行数。
<strong>filtered</strong>：所需数据占 rows 的比例。</p>
<h2 id="优化">优化</h2>
<ul>
<li><strong>覆盖索引</strong>：将 where 判断的，或者查询要使用的列A,B可以组合索引。</li>
<li><strong>order by</strong>：将排序加入索引(索引本身就是有序的)。</li>
<li><strong>count</strong>：估计值取代精确值，额外表或者 Redis 记录总数。
分布式事务不一致的话，如果短时间内业务可以接受，可以通过异步刷新 redis 的数量，也可以用 Canal 之类的工具监听 MySQL binlog 来刷新总数。</li>
<li><strong>索引提示</strong>：使用指定索引。FORCE INDEX、USE INDEX 和 IGNORE INDEX。</li>
<li><strong>where 替换 having</strong>：一般来说，数据库都是先根据 WHERE 条件找到候选的列，再根据 HAVING 条件进行二次过滤。 可以提前过滤减少查询时间。</li>
</ul>
<h1 id="数据库锁">数据库锁</h1>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/2024/09/3401170950.jpg"
        data-srcset="/images/2024/09/3401170950.jpg, /images/2024/09/3401170950.jpg 1.5x, /images/2024/09/3401170950.jpg 2x"
        data-sizes="auto"
        alt="/images/2024/09/3401170950.jpg"
        title="请输入图片描述" width="1202" height="1280" /></p>
<p>在 MySQL 的 <strong>InnoDB</strong> 引擎里面，锁是借助<strong>索引</strong>来实现的。或者说，加锁锁住的其实是索引项，更加具体地来说，就是锁住了<strong>叶子节点</strong> 。</p>
<p><strong>锁的释放时机</strong>：只有在执行 Rollback 或者 Commit 的时候，锁才会被释放掉。</p>
<h2 id="锁的类型">锁的类型</h2>
<h3 id="乐观锁和悲观锁">乐观锁和悲观锁</h3>
<ul>
<li>乐观锁是直到要修改数据的时候，才检测数据是否已经被别人修改过。</li>
<li>悲观锁是在初始时刻就直接加锁保护好临界资源</li>
</ul>
<h3 id="行锁与表锁">行锁与表锁</h3>
<p><strong>行锁</strong>：锁住一行或者多行。(借助索引来实现的，如果没有命中任何索引，则只能使用表锁)</p>
<p><strong>表锁</strong>：锁住整个表。</p>
<h3 id="共享锁和排他锁">共享锁和排他锁</h3>
<ul>
<li>共享锁是指一个线程加锁之后，其他线程还是可以继续加同类型的锁。</li>
<li>排它锁是指一个线程加锁之后，其他线程就不能再加锁了。</li>
</ul>
<p>可以理解为 读写锁，读(共享)，写(排他)。</p>
<h3 id="意向锁">意向锁</h3>
<p>意向锁相当于一个信号，就是告诉别人我要加锁了，所以意向锁并不是一个真正物理意义上的锁。</p>
<p>它能和排他锁结合，意向共享锁和意向排他锁。</p>
<p><strong>使用意向锁能够 提高数据库的并发性能，并且避免死锁问题。</strong></p>
<h3 id="记录锁间隙锁和临键锁">记录锁、间隙锁和临键锁</h3>
<p><strong>记录锁</strong>：锁住了特定的某一条记录的锁。
<strong>间隙锁</strong>：锁住了某一段记录的锁。（左开右开）</p>
<p><strong>记录锁和记录锁是排它的，但是间隙锁和间隙锁不是排它的</strong> 。</p>
<p><strong>临键锁</strong>：记录锁 + 间隙锁。<strong>临键锁不仅仅是会用记录锁锁住命中的记录，也会用间隙锁锁住记录之间的空隙</strong> 。（左开右闭）</p>
<h2 id="qa介绍一下-mysql-锁">QA:介绍一下 MySQL 锁</h2>
<p>MySQL 里面的锁机制特别丰富，这里我以 InnoDB 引擎为例。首先，从锁的范围来看，可以分成行锁和表锁。其次，从排它性来看，可以分成排它锁和共享锁。还有意向锁，结合排它性，就分为排它意向锁和共享意向锁。还有三个重要的锁概念，记录锁、间隙锁和临键锁。记录锁，是指锁住某条记录；间隙锁，是指锁住两条记录之间的位置；临键锁可以看成是记录锁与间隙锁的组合情况。</p>
<p>还有一种分类方法，是乐观锁和悲观锁。那么在数据库里面使用乐观锁，本质上是一种应用层面的 CAS 操作。</p>
<h2 id="qa临键锁引发的死锁">QA:临键锁引发的死锁</h2>
<p>当两个线程插入两个不存在的 id 时，线程都会产生 (id,supremum] 的临键锁，这个时候就会产生死锁问题，同时等待对方释放掉持有的间隙锁。</p>
<p><strong>解决方案</strong></p>
<ul>
<li>不管数据如何，直接插入一个默认数据，插入成功则是不存在，插入失败则是存在，所以不会使用间隙锁，使用了行锁。</li>
<li>调整数据库的隔离级别，降低为<strong>已提交读</strong>，就没有间隙锁了。</li>
<li>放弃悲观锁，使用乐观锁。CAS 原子操作。</li>
</ul>
<h1 id="mvcc-协议">MVCC 协议</h1>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/2024/09/3002231155.jpg"
        data-srcset="/images/2024/09/3002231155.jpg, /images/2024/09/3002231155.jpg 1.5x, /images/2024/09/3002231155.jpg 2x"
        data-sizes="auto"
        alt="/images/2024/09/3002231155.jpg"
        title="请输入图片描述" width="1280" height="1196" /></p>
<p>避免读写阻塞延申出 MVCC 协议。</p>
<h2 id="隔离级别从低到高">隔离级别(从低到高)</h2>
<ol>
<li>读未提交：是指一个事务可以看到另外一个事务尚未提交的修改。</li>
<li>读已提交：是指一个事务只能看到已经提交的事务的修改。 这意味着<strong>如果在事务执行过程中有别的事务提交了，那么事务还是能够看到别的事务最新 提交的修改。</strong></li>
<li>可重复读：是指在这一个事务内部读同一个数据多次，读到的结果都是同一个。这意味着即便<strong>在事务执行过程中有别的事务提交，这个事务依旧看不到别的事务提交的修改</strong> 。这是 MySQL 默认的隔离级别。</li>
<li>串行化：是指事务对数据的读写都是串行化的。</li>
</ol>
<h2 id="异常">异常</h2>
<ul>
<li>脏读：读到了别的事务还没有提交的数据。之所以叫做“脏”读，就是因为未提交数据可能会被回滚掉。</li>
<li>不可重复读：一个事务执行过程中，对同一行数据读到的结果不同。</li>
<li>幻读：事务执行过程中，别的事务插入了新的数据并且提交了，然后事务在后续步骤中读到了这个新的数据。</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/2024/09/3092940619.jpg"
        data-srcset="/images/2024/09/3092940619.jpg, /images/2024/09/3092940619.jpg 1.5x, /images/2024/09/3092940619.jpg 2x"
        data-sizes="auto"
        alt="/images/2024/09/3092940619.jpg"
        title="请输入图片描述" width="1280" height="500" /></p>
<p><strong>理论上来说可重复读是没有解决幻读的</strong> 。但是 MySQL 因为使用了临键锁，因此它的可重复读隔离级别已经解决了幻读问题。</p>
<h2 id="快照读和当前读">快照读和当前读</h2>
<ul>
<li>快照读就是在事务开始的时候创建 了一个数据的快照，在整个事务过程中都读这个快照</li>
<li>当前读，则是每次都去读最新数 据。MySQL 在可重复读这个隔离级别下，查询的执行效果和快照读非常接近。</li>
</ul>
<h2 id="read-view">Read View</h2>
<p>Read View 只能用于 <strong>读已提交</strong>和<strong>可重复读</strong>。</p>
<ul>
<li>读已提交：每次发起查询都会创建一个新的 Read View。</li>
<li>可重复读：事务开始时，创建 Read View。</li>
</ul>
<h2 id="qa什么是-mccc-">QA:什么是 MCCC ?</h2>
<p>MVCC 是 MySQL InnoDB 引擎用于控制数据并发访问的协议。MV 借助于版本链来实现的。在 InnoDB 引擎里面，每一行都有两个额外的列，一 个是 trx_id，代表的是修改这一行数据的事务 ID。另外一个是 r 的是回滚指针。InnoDB 引擎通过回滚指针，将数据的不同版本串联在一起， 也就是版本链。这些串联起来的历史版本，被放到了 undolog 里面。当某一个 事务发起查询的时候，MVCC 会根据事务的隔离级别来生成不同的 Read View，从而控制事务查询最终得到的结果。</p>
<h1 id="数据库事务">数据库事务</h1>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/2024/09/3881946703.jpg"
        data-srcset="/images/2024/09/3881946703.jpg, /images/2024/09/3881946703.jpg 1.5x, /images/2024/09/3881946703.jpg 2x"
        data-sizes="auto"
        alt="/images/2024/09/3881946703.jpg"
        title="请输入图片描述" width="1183" height="1280" /></p>
<h2 id="undo-log回滚日志">undo log(回滚日志)</h2>
<p>记录日志，相反操作来恢复数据库</p>
<h2 id="redo-log操作日志">redo log(操作日志)</h2>
<p>innoDB 引擎写数据时先修改内存的数据同时写redo log，然后刷磁盘。如果此时G了，可以通过 redo log来写入。</p>
<h2 id="acid">ACID</h2>
<p>事务的 ACID 特性是指原子性（Atomicity）、一致性 （Consistency）、隔离性 （Isolation）还有持久性（Durability）。</p>
<ul>
<li>原子性：事务是一个不可分割的整体，它在执行过程中不能被中断或推迟，它的所有操作 都必须一次性执行，要么都成功，要么都失败。</li>
<li>一致性：事务执行的结果必须满足数据约束条件，不会出现矛盾的结果。注意这里的一致 性和我们讨论的分布式环境下的一致性语义有所差别，后者强调的是不同数据源之间数据 一致。</li>
<li>隔离性：事务在执行的时候可以隔离其他事务的干扰，也就是不同事务之间不会相互影 响。</li>
<li>持久性：事务执行的结果必须保证在数据库里永久保存，即使系统出现故障或者数据库被 删除，事务的结果也不会丢失。</li>
</ul>
<h1 id="主键生成算法">主键生成算法</h1>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/2024/09/3398729439.jpg"
        data-srcset="/images/2024/09/3398729439.jpg, /images/2024/09/3398729439.jpg 1.5x, /images/2024/09/3398729439.jpg 2x"
        data-sizes="auto"
        alt="/images/2024/09/3398729439.jpg"
        title="请输入图片描述" width="1280" height="1163" /></p>
<h2 id="uuid">UUID</h2>
<h3 id="弊端">弊端</h3>
<ul>
<li>过长</li>
<li>UUID 不是递增的</li>
</ul>
<h3 id="页分裂">页分裂</h3>
<p>UUID 最大的缺陷是它产生的 ID 不是递增的。一般来说，我们倾向于在数据库中使用自增主键，因为这样可以迫使数据库的树朝着一个方向增长，而不会造成中间叶节点分裂，这样插入性能最好。而整体上 UUID 生成的 ID 可以看作是随机，那么就会导致数据往页中间插入，引起更加频繁地页分裂，在糟糕的情况下，这种分裂可能引起连锁反应，整棵树的树形结构都会受到影响。所以我们普遍倾向于采用递增的主键。</p>
<h3 id="顺序读"><strong>顺序读</strong></h3>
<p>自增主键还有一个好处，就是数据会有更大的概率按照主键的大小排序，两条主键相近的记录，在磁盘上位置也是相近的。那么可以预计，在范围查询的时候，我们能够更加充分地利用到磁盘的顺序读特性。</p>
<h2 id="数据库自增设置步长">数据库自增(设置步长)</h2>
<p>经过分库分表之后我有十个表，那么我可以让每一个表按照步长来生成自增 ID。比如说第一个表就是生成 1、11、21、31 这种 ID，第二个表就是生成 2、12、22、32 这种 ID。</p>
<h2 id="雪花算法">雪花算法</h2>
<p>雪花算法采用 64 位来表示一个 ID，其中 1 比特保留，41 比特表示<strong>时间戳</strong>， 10 比特作为<strong>机器 ID</strong>，12 比特作为<strong>序列号</strong>。</p>
<h3 id="序列号耗尽">序列号耗尽</h3>
<ul>
<li>12比特不够用，从时间戳拿比特增加到序列号上</li>
<li>等待下一时刻继续生成(限流)</li>
</ul>
<p>一般来说可以考虑加长序列号的长度，比如说缩减时间戳，然后挪给序列号 ID。当然也可以更加简单粗暴地将 64 位的 ID 改成 96 位的 ID，那么序列号 ID 就可以有三四十位，即便是国际大厂也不可能用完了。不过，彻底的兜底方 案还是要有的。我们可以考虑引入类似限流的做法，在当前时刻的 ID 已经耗尽 之后，可以让业务方等一下。我们的时间戳一般都是毫秒数，那么业务方最多 就会等一毫秒。</p>
<h3 id="数据堆积">数据堆积</h3>
<p>QA:你设想这么一个场景：你的分库分表是按照 ID 除以 32 的余数来进行的，那么如果你的业务 非常低频，以至于每一个时刻都只生成了尾号为 1 的 ID，那么是不是所有的数据都分到了一 张表里面呢？</p>
<p>在低频场景下，很容易出现序列号几乎没有增长，从而导致数据在经过分库分 表之后只落到某一张表里面的情况。为了解决这种问题，可以考虑这么做，序 列号部分不再是从 0 开始增长，而是从一个随机数开始增长。还有一个策略就 是序列号从上一时刻的序列号开始增长，但是如果上一时刻序列号已经很大! 了，那么就可以退化为从 0 开始增长。这样的话要比随机数更可控一点，并且 性能也要更好一点。</p>
<h2 id="主键内嵌分库分表键"><strong>主键内嵌分库分表键</strong></h2>
<p>大多数时候，我们会面临一个问题，就是分库分表的键和主键并不是同一个。 比如说在 C 端的订单分库分表，我们可以采用买家 ID 来进行分库分表。但是 一些业务场景，比如说查看订单详情，可能是根据主键又或者是根据订单 SN 来查找的。</p>
<p>那么我们可以考虑借鉴雪花算法的设计，将主键生成策略和分库分表键结合在 一起，也就是说在主键内部嵌入分库分表键。例如，我们可以这样设计订单 ID 的生成策略，在这里我们假设分库分表用的是买家 ID 的后四位。第一段依旧是 采用时间戳，但是第二段我们就换成了这个买家后四位，第三段我们采用随机数。</p>
<p>普遍情况下，我们都是用买家 ID 来查询对应的订单信息。在别的场景下，比如 说我们只有一个订单 ID，这种时候我们可以取出订单 ID 里嵌入进去的买家 ID 后四位，来判断数据存储在哪个库、哪个表。类似的设计还有答题记录按照答 题者 ID 来分库分表，但是答题记录 ID 本身可以嵌入这个答题者 ID 中用于分 库分表的部分。</p>
<h1 id="分库分表分页">分库分表分页</h1>
<h2 id="分库分表">分库分表</h2>
<p>三种算法</p>
<ol>
<li>哈希分库分表：ID 取余</li>
<li>范围分库分表：按照 ID 范围，日期范围</li>
<li>中间表：引入一个中间表来记录映射关系</li>
</ol>
<h1 id="分布式事务如何同时保证分库分表acid和高性能">分布式事务，如何同时保证分库分表、ACID和高性能？</h1>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2024-09-01</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://localhost:1313/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98/" data-title="数据库_MySQL"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98/" data-title="数据库_MySQL"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://localhost:1313/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98/" data-title="数据库_MySQL"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/%E6%95%B0%E6%8D%AE%E5%BA%93_mysql%E9%97%AE%E9%A2%98/" data-title="数据库_MySQL"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/go%E5%B9%B6%E5%8F%91%E5%9F%BA%E6%9C%AC%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%ADwaitgroup/" class="prev" rel="prev" title="Go并发_基本并发原语_WaitGroup"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Go并发_基本并发原语_WaitGroup</a>
            <a href="/%E6%95%B0%E6%8D%AE%E5%BA%93_redis/" class="next" rel="next" title="数据库_Redis">数据库_Redis<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.144.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">xxxx</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/contrib/auto-render.min.js"></script><script src="/lib/katex/contrib/copy-tex.min.js"></script><script src="/lib/katex/contrib/mhchem.min.js"></script><script src="/lib/cookieconsent/cookieconsent.min.js"></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
